<!DOCTYPE html>
<html>
<head>
    <title>Lumos | Bio-Sensing Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .card { background: #1e293b; border: 1px solid #334155; color: white; border-radius: 12px; }
        #log-window { height: 180px; background: #000; color: #10b981; font-family: monospace; font-size: 0.75rem; overflow-y: auto; padding: 10px; border-radius: 8px; border: 1px solid #334155; }
        .metric-label { font-size: 0.7rem; text-transform: uppercase; color: #94a3b8; }
        .matrix-cell { flex: 1; height: 24px; margin: 1px; border-radius: 2px; transition: background 0.1s; background: #0f172a; }
        .pd-label { width: 80px; font-size: 0.7rem; color: #94a3b8; font-weight: bold; }
        .led-label { font-size: 0.6rem; text-align: center; color: #64748b; transform: rotate(-45deg); height: 30px; }
    </style>
</head>
<body class="p-4">

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-md-4"><h2>LUMOS <span class="badge bg-primary">V3</span></h2></div>
        <div class="col-md-8 d-flex gap-2 justify-content-end">
            <select id="port-list" class="form-select w-auto bg-dark text-white border-secondary"></select>
            <button class="btn btn-primary" onclick="connectDevice()">Connect</button>
            <button id="rec-btn" class="btn btn-outline-danger" onclick="toggleRecord()" disabled>Start Record</button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-3">
            <div class="card p-3 mb-3">
                <h6>DEVICE SPECS</h6>
                <div class="mb-2"><div class="metric-label">Serial ID</div><div>{{info.sn}}</div></div>
                <div class="mb-2"><div class="metric-label">Battery</div><div class="text-success">{{info.battery}}</div></div>
                <div class="mb-2"><div class="metric-label">Uptime</div><div id="boot-time">00-00-00.000</div></div>
            </div>
            <div class="card p-3 mb-3">
                <h6>SERIAL LOG (RAW)</h6>
                <div id="log-window"></div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card p-3 mb-3">
                <h6 class="text-info">ABSORBANCE & INTENSITY SPECTRUM</h6>
                <canvas id="spectrumChart" height="90"></canvas>
                <canvas id="intensityChart" height="50" class="mt-2"></canvas>
            </div>

            <div class="card p-3">
                <h6 class="text-info mb-3">MULTI-WAVELENGTH SIGNAL MATRIX (11 PD x 17 LED)</h6>
                <div id="matrix-container">
                    <div class="d-flex mb-2" id="led-headers" style="padding-left: 80px;"></div>
                    <div id="matrix-grid" class="d-flex flex-column-reverse"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const socket = io();
    const LED_WAVELENGTHS = [1650, 1550, 1450, 1300, 1250, 1050, 940, 850, 660, 633, 599, 567, 530, 500, 470, 450, 415];
    const SORTED_LEDS = [...LED_WAVELENGTHS].reverse(); // 415 -> 1650
    const PD_LABELS = ["415nm", "445nm", "480nm", "515nm", "555nm", "590nm", "630nm", "680nm", "910nm", "Clear", "Infrared"];
    const PD_MAPPING = [10, 10, 10, 10, 10, 10, 8, 8, 7, 6, 5, 4, 3, 3, 2, 1, 0];

    // --- UTILITY: Dual Scale Normalization ---
    function normalize(val, wavelength) {
        if (wavelength >= 1050) {
            // Scale 0-25500 down to 0-950
            return (val / 25500) * 950;
        }
        return val; // Keep 0-25500 for visible range
    }

    // --- INITIALIZE CHARTS ---
    const ctxSpec = document.getElementById('spectrumChart').getContext('2d');
    const spectrumChart = new Chart(ctxSpec, {
        type: 'line',
        data: {
            labels: SORTED_LEDS.map(l => l + "nm"),
            datasets: [{ label: 'Reconstructed Spectrum', data: new Array(17).fill(0), borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.3 }]
        },
        options: { animation: false, scales: { y: { beginAtZero: true, grid: { color: '#334155' } } } }
    });

    const ctxInt = document.getElementById('intensityChart').getContext('2d');
    const intensityChart = new Chart(ctxInt, {
        type: 'bar',
        data: {
            labels: SORTED_LEDS.map(l => l + "nm"),
            datasets: [{ label: 'LED Intensity (PWM)', data: new Array(17).fill(0), backgroundColor: '#a855f7' }]
        },
        options: { animation: false, scales: { y: { max: 4096, grid: { color: '#334155' } } } }
    });

    // --- INITIALIZE MATRIX ---
    const gridEl = document.getElementById('matrix-grid');
    const headerEl = document.getElementById('led-headers');
    const matrixCells = []; // 2D Reference [pd_idx][visual_led_idx]

    // Create LED Labels at top
    SORTED_LEDS.forEach(wl => {
        const div = document.createElement('div');
        div.className = "flex-grow-1 led-label";
        div.innerText = wl;
        headerEl.appendChild(div);
    });

    // Create PD Rows (Bottom to Top)
    PD_LABELS.forEach((pdName, pdIdx) => {
        const row = document.createElement('div');
        row.className = "d-flex align-items-center";
        const label = document.createElement('div');
        label.className = "pd-label";
        label.innerText = pdName;
        row.appendChild(label);

        const rowCells = [];
        SORTED_LEDS.forEach(() => {
            const cell = document.createElement('div');
            cell.className = "matrix-cell";
            row.appendChild(cell);
            rowCells.push(cell);
        });
        gridEl.appendChild(row);
        matrixCells.push(rowCells);
    });

    // --- DATA HANDLING ---
    socket.on('data_update', (msg) => {
        const rawIdx = msg.led_idx; // 0 (1650) to 16 (415)
        const currentWl = LED_WAVELENGTHS[rawIdx];
        const visualIdx = 16 - rawIdx; // Map to 0 (415) to 16 (1650)

        // 1. Update Intensity (Show for all)
        intensityChart.data.datasets[0].data[visualIdx] = msg.intensity;
        intensityChart.update('none');

        // 2. Update Spectrum (Using normalized target PD)
        const targetPdVal = msg.readings[PD_MAPPING[rawIdx]];
        spectrumChart.data.datasets[0].data[visualIdx] = normalize(targetPdVal, currentWl);
        spectrumChart.update('none');

        // 3. Update Matrix Grid
        msg.readings.forEach((val, pdIdx) => {
            const scaled = normalize(val, currentWl);
            const limit = currentWl >= 1050 ? 950 : 25500;
            const opacity = Math.min(scaled / limit, 1.0);
            
            // NIR LEDs (1050+) show Red heatmap, Visible show Blue heatmap
            const color = currentWl >= 1050 ? `rgba(239, 68, 68, ${opacity})` : `rgba(59, 130, 246, ${opacity})`;
            matrixCells[pdIdx][visualIdx].style.background = color;
        });

        // 4. Update UI
        document.getElementById('boot-time').innerText = msg.boot_time;
        updateLog(msg.raw);
    });

    function updateLog(txt) {
        const log = document.getElementById('log-window');
        const line = document.createElement('div');
        line.innerText = txt;
        log.prepend(line);
        if(log.childNodes.length > 50) log.lastChild.remove();
    }

    // Port Management
    async function loadPorts() {
        const res = await fetch('/get_ports');
        const data = await res.json();
        const el = document.getElementById('port-list');
        el.innerHTML = data.ports.map(p => `<option value="${p}">${p}</option>`).join('') || '<option>No Ports</option>';
    }

    async function connectDevice() {
        const port = document.getElementById('port-list').value;
        const res = await fetch('/connect', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({port}) });
        const data = await res.json();
        if(data.status === 'connected') {
            document.getElementById('rec-btn').disabled = false;
            alert("Connected!");
        }
    }

    async function toggleRecord() {
        const btn = document.getElementById('rec-btn');
        const action = btn.innerText.includes("Start") ? "start" : "stop";
        const res = await fetch('/record', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action}) });
        const data = await res.json();
        btn.innerText = action === "start" ? "Stop Record" : "Start Record";
        btn.className = action === "start" ? "btn btn-danger" : "btn btn-outline-danger";
        if(action === "stop") alert("File: " + data.path);
    }

    window.onload = loadPorts;
</script>
</body>
</html>