<!-- templates/index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>OptiLact Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .card { background: #1e293b; border: 1px solid #334155; color: white; border-radius: 12px; }

        /* Header */
        .brand-title { font-weight: 700; letter-spacing: 0.2px; }
        .topbar { align-items: center; }

        /* Device specs "table" */
        .spec-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .spec-table td { padding: 6px 0; border-bottom: 1px solid #334155; vertical-align: top; }
        .spec-key { color: #94a3b8; text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.08em; width: 42%; }
        .spec-val { color: #e2e8f0; }
        .spec-table tr:last-child td { border-bottom: none; }

        /* Charts sizing */
        .chart-tall canvas { width: 100% !important; }
        /* NOTE: Chart.js respects the element's height if maintainAspectRatio=false */
        .chart-wrap { position: relative; height: 260px; }
        .chart-wrap-sm { position: relative; height: 160px; }

        /* Matrix */
        .matrix-header-pad { padding-left: 120px; }
        .pd-label { width: 90px; font-size: 0.75rem; color: #94a3b8; font-weight: 700; }
        .range-label { width: 70px; font-size: 0.7rem; color: #64748b; text-align: right; padding-right: 8px; }
        .led-label { font-size: 0.65rem; text-align: center; color: #64748b; transform: rotate(-45deg); height: 34px; }

        .matrix-cell {
            position: relative;
            flex: 1;
            height: 38px;            /* larger */
            margin: 2px;
            border-radius: 6px;
            background: #0b1220;
            border: 1px solid #22314a;
            overflow: hidden;
        }
        .cell-fill {
            position: absolute;
            left: 0; bottom: 0;
            width: 100%;
            height: 0%;
            background: #3b82f6;     /* single color */
            opacity: 0.9;
            transition: height 0.08s linear;
        }
        .cell-text {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.75rem;
            color: #e2e8f0;
            text-shadow: 0 1px 0 rgba(0,0,0,0.5);
            pointer-events: none;
        }

        /* Log */
        #log-window {
            height: 260px; /* bigger */
            background: #000;
            color: #10b981;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.85rem;
            overflow-y: auto;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #334155;
            white-space: pre;       /* keep lines clean */
        }
        .axis-title {
            font-size: 0.7rem;
            color: #94a3b8;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }
        .axis-title-led { padding-left: 120px; margin-bottom: 6px; }
        .axis-title-pd  { width: 90px; text-align: left; }

        /* ----------------------------
           NEW: Prediction panel styling
           ---------------------------- */
        .pred-card {
            border-radius: 14px;
            background: linear-gradient(180deg, rgba(30,41,59,1) 0%, rgba(15,23,42,1) 100%);
            border: 1px solid #334155;
            box-shadow: 0 10px 22px rgba(0,0,0,0.25);
        }
        .pred-header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
        }
        .pred-title {
            font-weight: 800;
            letter-spacing: 0.2px;
            font-size: 0.95rem;
        }
        .pred-sub {
            color: #94a3b8;
            font-size: 0.75rem;
            letter-spacing: 0.06em;
            text-transform: uppercase;
        }
        .pred-body {
            background: rgba(2,6,23,0.35);
            border: 1px solid rgba(51,65,85,0.6);
            border-radius: 12px;
            padding: 12px;
        }
        .pred-spinner-wrap {
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 10px;
            padding: 14px 0 6px 0;
        }
        .pred-steps {
            margin: 10px 0 0 0;
            padding: 0;
            list-style: none;
            font-size: 0.85rem;
            color: #cbd5e1;
        }
        .pred-steps li {
            padding: 6px 10px;
            border-radius: 10px;
            border: 1px solid transparent;
            margin-bottom: 6px;
            background: rgba(15, 23, 42, 0.35);
        }
        .pred-steps li.active {
            border-color: rgba(59,130,246,0.6);
            background: rgba(59,130,246,0.12);
            color: #e2e8f0;
        }
        .pred-steps li.done {
            border-color: rgba(34,197,94,0.45);
            background: rgba(34,197,94,0.10);
            color: #bbf7d0;
        }
        .pred-result {
            margin-top: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(51,65,85,0.6);
            background: rgba(2,6,23,0.45);
            display: none;
        }
        .pred-result .k {
            color: #94a3b8;
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        .pred-result .v {
            font-size: 1.1rem;
            font-weight: 800;
            margin-top: 2px;
        }
        .pred-meta {
            color: #94a3b8;
            font-size: 0.8rem;
            margin-top: 4px;
            word-break: break-all;
        }
        .led-status-img {
            width: 100%;
            max-width: 260px;
            height: auto;
            border-radius: 12px;
            border: 1px solid #334155;
            background: #0b1220;
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body class="p-4">

<div class="container-fluid">
    <div class="row mb-3 topbar">
        <div class="col-md-4"></div>

        <!-- Center title -->
        <div class="col-md-4 text-center">
            <h2 class="brand-title m-0">OptiLact Dashboard</h2>
        </div>

        <!-- Keep controls as-is (layout only) -->
        <div class="col-md-4 d-flex gap-2 justify-content-end">
            <select id="port-list" class="form-select w-auto bg-dark text-white border-secondary"></select>
            <button class="btn btn-primary" onclick="connectDevice()">Connect</button>
            <button id="rec-btn" class="btn btn-outline-danger" onclick="toggleRecord()" disabled>Start Record</button>
        </div>
    </div>

    <div class="row">
        <!-- Left: device info -->
        <div class="col-md-3">
            <div class="card p-3 mb-3">
                <h6 class="mb-3">DEVICE INFO</h6>
                <table class="spec-table">
                    <tr>
                        <td class="spec-key">Serial ID</td>
                        <td class="spec-val">{{info.sn}}</td>
                    </tr>
                    <tr>
                        <td class="spec-key">Device ID</td>
                        <td class="spec-val">{{info.id}}</td>
                    </tr>
                    <tr>
                        <td class="spec-key">Manufacturer</td>
                        <td class="spec-val">{{info.mfg}}</td>
                    </tr>
                    <tr>
                        <td class="spec-key">Programmed</td>
                        <td class="spec-val">{{info.programmed}}</td>
                    </tr>
                    <tr>
                        <td class="spec-key">Storage</td>
                        <td class="spec-val">{{info.storage}}</td>
                    </tr>
                    <tr>
                        <td class="spec-key">User</td>
                        <td class="spec-val">{{info.user}}</td>
                    </tr>
                    <tr>
                        <td class="spec-key">Battery</td>
                        <td class="spec-val text-success fw-semibold">{{info.battery}}</td>
                    </tr>
                    <tr>
                        <td class="spec-key">Uptime</td>
                        <td class="spec-val" id="boot-time">00-00-00.000</td>
                    </tr>
                </table>
            </div>

            <!-- ------------------------------------
                 NEW: Lactate Prediction panel
                 ------------------------------------ -->
            <div class="card p-3 mb-3 pred-card">
                <div class="pred-header">
                    <div>
                        <div class="pred-title">Lactate Prediction</div>
                        <div class="pred-sub">1-minute capture • placeholder</div>
                    </div>
                    <button id="btn-lactate" class="btn btn-primary btn-sm" onclick="startLactatePrediction()">
                        Predict Lactate
                    </button>
                </div>

                <div class="pred-body">
                    <div id="lactate-spinner" class="pred-spinner-wrap">
                        <div class="spinner-border text-info" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="w-100">
                            <div class="progress" style="height: 10px; background: rgba(148,163,184,0.15);">
                                <div id="lactate-progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div id="lactate-progress-text" class="text-center mt-2" style="color:#94a3b8; font-size:0.85rem;">
                                0%
                            </div>
                            <div id="lactate-capture-text" class="text-center" style="color:#64748b; font-size:0.8rem;">
                                <!-- capture timer text -->
                            </div>
                        </div>
                    </div>

                    <ul id="lactate-steps" class="pred-steps"></ul>

                    <div id="lactate-result" class="pred-result">
                        <div class="k">Predicted Lactate</div>
                        <div id="lactate-value" class="v">—</div>
                        <div id="lactate-note" class="pred-meta"></div>
                        <div id="lactate-file" class="pred-meta"></div>
                    </div>
                </div>
            </div>

            <!-- ------------------------------------
                 NEW: Skin Tone Prediction panel
                 ------------------------------------ -->
            <div class="card p-3 mb-3 pred-card">
                <div class="pred-header">
                    <div>
                        <div class="pred-title">Skin Tone Prediction</div>
                        <div class="pred-sub">1-minute capture • placeholder</div>
                    </div>
                    <button id="btn-skin" class="btn btn-outline-info btn-sm" onclick="startSkinTonePrediction()">
                        Predict Skin Tone
                    </button>
                </div>

                <div class="pred-body">
                    <div id="skin-spinner" class="pred-spinner-wrap">
                        <div class="spinner-border text-info" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="w-100">
                            <div class="progress" style="height: 10px; background: rgba(148,163,184,0.15);">
                                <div id="skin-progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div id="skin-progress-text" class="text-center mt-2" style="color:#94a3b8; font-size:0.85rem;">
                                0%
                            </div>
                            <div id="skin-capture-text" class="text-center" style="color:#64748b; font-size:0.8rem;">
                                <!-- capture timer text -->
                            </div>
                        </div>
                    </div>

                    <ul id="skin-steps" class="pred-steps"></ul>

                    <div id="skin-result" class="pred-result">
                        <div class="k">Predicted Skin Tone</div>
                        <div id="skin-value" class="v">—</div>
                        <div id="skin-note" class="pred-meta"></div>
                        <div id="skin-file" class="pred-meta"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: charts + matrix + log -->
        <div class="col-md-9">
            <div class="card p-3 mb-3 chart-tall">
                <h6 class="text-info mb-3">ABSORBANCE &amp; INTENSITY SPECTRUM</h6>

                <div class="chart-wrap">
                    <canvas id="spectrumChart"></canvas>
                </div>

                <div class="chart-wrap-sm mt-3">
                    <canvas id="intensityChart"></canvas>
                </div>
            </div>

            <div class="card p-3 mb-3">
                <h6 class="text-info mb-3">MULTI-WAVELENGTH SIGNAL MATRIX (11 PD x 17 LED)</h6>
                <div id="matrix-container">
                    <div class="axis-title axis-title-led">LED (nm) →</div>
                    <div class="d-flex mb-2 matrix-header-pad" id="led-headers"></div>
                    <div id="matrix-grid" class="d-flex flex-column-reverse"></div>
                </div>
            </div>

            <div class="card p-3">
                <h6 class="mb-3">SERIAL LOG (RAW)</h6>
                <div id="log-window"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const socket = io();

    const LED_WAVELENGTHS = [1650, 1550, 1450, 1300, 1250, 1050, 940, 850, 660, 633, 599, 567, 530, 500, 470, 450, 415];
    const SORTED_LEDS = [...LED_WAVELENGTHS].reverse(); // 415 -> 1650
    const PD_LABELS = ["415nm", "445nm", "480nm", "515nm", "555nm", "590nm", "630nm", "680nm", "910nm", "Clear", "Infrared"];
    const PD_MAPPING = [10, 10, 10, 10, 10, 10, 8, 8, 7, 6, 5, 4, 3, 3, 2, 1, 0];

    // Per your request: each cell has its own range on its y-axis.
    // Here we set a fixed range 0..25500 for all cells.
    const CELL_MIN = 0;
    const CELL_MAX_DEFAULT = 25500;
    const IR_PD_INDEX = 10;          // PD_LABELS index for "Infrared"
    const IR_CELL_MAX = 950;         // requested scale for Infrared

    function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }
    function pctForPd(val, pdIdx) {
        const max = (pdIdx === IR_PD_INDEX) ? IR_CELL_MAX : CELL_MAX_DEFAULT;
        const p = ((val - CELL_MIN) / (max - CELL_MIN)) * 100;
        return clamp(p, 0, 100);
    }

    // --- CHARTS ---
    const ctxSpec = document.getElementById('spectrumChart').getContext('2d');

    // Identify which x positions correspond to 1050–1650nm (inclusive)
    const IR_MIN_WL = 1050;
    const IR_MAX_WL = 1650;
    const isIRIndex = (i) => {
        const wl = SORTED_LEDS[i];
        return (wl >= IR_MIN_WL && wl <= IR_MAX_WL);
    };

    const spectrumChart = new Chart(ctxSpec, {
        type: 'line',
        data: {
            labels: SORTED_LEDS.map(l => l + "nm"),
            datasets: [
                {
                    label: 'Reconstructed Spectrum (415–940nm)',
                    data: new Array(17).fill(0),
                    yAxisID: 'yVis',
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.12)',
                    fill: true,
                    tension: 0.3,
                    spanGaps: false
                },
                {
                    label: 'Reconstructed Spectrum (1050–1650nm)',
                    data: new Array(17).fill(0),
                    yAxisID: 'yIr',
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.10)',
                    fill: true,
                    tension: 0.3,
                    spanGaps: false
                }
            ]
        },
        options: {
            animation: false,
            maintainAspectRatio: false,
            scales: {
                yVis: {
                    type: 'linear',
                    position: 'left',
                    beginAtZero: true,
                    grid: { color: '#334155' },
                    ticks: {
                        // more granular than default without getting too dense
                        stepSize: 2500
                    }
                },
                yIr: {
                    type: 'linear',
                    position: 'right',
                    beginAtZero: true,
                    max: 950,
                    grid: {
                        // don’t draw a second grid on top of the first
                        drawOnChartArea: false
                    },
                    ticks: {
                        stepSize: 50
                    }
                },
                x: { grid: { color: '#22314a' } }
            },
            plugins: { legend: { labels: { color: '#cbd5e1' } } }
        }
    });

    const ctxInt = document.getElementById('intensityChart').getContext('2d');
    const intensityChart = new Chart(ctxInt, {
        type: 'bar',
        data: {
            labels: SORTED_LEDS.map(l => l + "nm"),
            datasets: [{
                label: 'LED Intensity (PWM)',
                data: new Array(17).fill(0),
                backgroundColor: '#a855f7'
            }]
        },
        options: {
            animation: false,
            maintainAspectRatio: false,
            scales: {
                y: {
                    max: 4096,
                    grid: { color: '#334155' },
                    ticks: {
                        // finer tick spacing than before
                        stepSize: 25
                    }
                },
                x: { grid: { color: '#22314a' } }
            },
            plugins: { legend: { labels: { color: '#cbd5e1' } } }
        }
    });

    // --- MATRIX ---
    const gridEl = document.getElementById('matrix-grid');
    const headerEl = document.getElementById('led-headers');

    // PD axis title row (left side)
    const pdTitleRow = document.createElement('div');
    pdTitleRow.className = "d-flex align-items-center mb-1";

    const pdTitle = document.createElement('div');
    pdTitle.className = "pd-label axis-title";
    pdTitle.innerText = "PD ↑";
    pdTitleRow.appendChild(pdTitle);

    // spacer to align with range-label column
    const rangeSpacer = document.createElement('div');
    rangeSpacer.className = "range-label";
    rangeSpacer.innerText = "";
    pdTitleRow.appendChild(rangeSpacer);

    // spacer to align with matrix cells
    const cellsSpacer = document.createElement('div');
    cellsSpacer.style.flex = "1";
    pdTitleRow.appendChild(cellsSpacer);

    gridEl.parentElement.insertBefore(pdTitleRow, gridEl);

    // Store references to fill + text elements per cell: [pdIdx][visualIdx] => {fillEl, textEl}
    const matrixCells = [];

    // LED header labels
    SORTED_LEDS.forEach(wl => {
        const div = document.createElement('div');
        div.className = "flex-grow-1 led-label";
        div.innerText = wl;
        headerEl.appendChild(div);
    });

    // Create PD rows (bottom to top)
    PD_LABELS.forEach((pdName, pdIdx) => {
        const row = document.createElement('div');
        row.className = "d-flex align-items-center";

        const label = document.createElement('div');
        label.className = "pd-label";
        label.innerText = pdName;
        row.appendChild(label);

        // y-axis range label per row (requested)
        const range = document.createElement('div');
        range.className = "range-label";
        range.innerText = (pdIdx === IR_PD_INDEX) ? "0–950" : "0–25500";
        row.appendChild(range);

        const rowCells = [];
        SORTED_LEDS.forEach(() => {
            const cell = document.createElement('div');
            cell.className = "matrix-cell";

            const fill = document.createElement('div');
            fill.className = "cell-fill";
            cell.appendChild(fill);

            const txt = document.createElement('div');
            txt.className = "cell-text";
            txt.innerText = "0%";
            cell.appendChild(txt);

            row.appendChild(cell);
            rowCells.push({ fillEl: fill, textEl: txt });
        });

        gridEl.appendChild(row);
        matrixCells.push(rowCells);
    });

    // --- DATA HANDLING ---
    socket.on('data_update', (msg) => {
        const rawIdx = msg.led_idx;               // 0 (1650) to 16 (415)
        const visualIdx = 16 - rawIdx;            // 0 (415) to 16 (1650)

        // 1) Intensity chart
        intensityChart.data.datasets[0].data[visualIdx] = msg.intensity;
        intensityChart.update('none');

        // 2) Spectrum chart (using target PD mapping)
        const targetPdVal = msg.readings[PD_MAPPING[rawIdx]];

        // Split across two Y axes:
        // - 415–940nm -> yVis dataset gets value, yIr gets null
        // - 1050–1650nm -> yIr dataset gets value, yVis gets null
        if (isIRIndex(visualIdx)) {
            spectrumChart.data.datasets[0].data[visualIdx] = null;
            spectrumChart.data.datasets[1].data[visualIdx] = targetPdVal;
        } else {
            spectrumChart.data.datasets[0].data[visualIdx] = targetPdVal;
            spectrumChart.data.datasets[1].data[visualIdx] = null;
        }
        spectrumChart.update('none');

        // 3) Matrix: fill percentage (no color distinctions)
        msg.readings.forEach((val, pdIdx) => {
            const p = pctForPd(val, pdIdx);
            const cell = matrixCells[pdIdx][visualIdx];
            cell.fillEl.style.height = p.toFixed(1) + "%";
            cell.textEl.innerText = Math.round(p) + "%";
        });

        // 4) UI
        document.getElementById('boot-time').innerText = msg.boot_time;
        updateLog(msg.raw);
    });

    function updateLog(txt) {
        const log = document.getElementById('log-window');
        const line = document.createElement('div');
        line.innerText = txt;
        log.prepend(line);
        if (log.childNodes.length > 200) log.lastChild.remove();
    }

    // Port Management (unchanged behavior)
    async function loadPorts() {
        const res = await fetch('/get_ports');
        const data = await res.json();
        const el = document.getElementById('port-list');
        el.innerHTML = data.ports.map(p => `<option value="${p}">${p}</option>`).join('') || '<option>No Ports</option>';
    }

    async function connectDevice() {
        const port = document.getElementById('port-list').value;
        const res = await fetch('/connect', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({port}) });
        const data = await res.json();
        if (data.status === 'connected') {
            document.getElementById('rec-btn').disabled = false;
            alert("Connected!");
        }
    }

    async function toggleRecord() {
        const btn = document.getElementById('rec-btn');
        const action = btn.innerText.includes("Start") ? "start" : "stop";
        const res = await fetch('/record', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action}) });
        const data = await res.json();
        btn.innerText = action === "start" ? "Stop Record" : "Start Record";
        btn.className = action === "start" ? "btn btn-danger" : "btn btn-outline-danger";
        if (action === "stop") alert("File: " + data.path);
    }

    // -------------------------------------------------
    // NEW: Prediction UI + Socket.IO progress handlers
    // -------------------------------------------------
    const LACTATE_STEPS = [
        "Start Predicting Lactate",
        "Removing Motion Artifacts",
        "Intensity Calibration",
        "Incident Light Measurement",
        "Ambient Light Cancellation",
        "Absorbance Feature Extraction",
        "Skin Tone Calibration",
        "Data Normalization",
        "Passing into Machine Learning Model",
        "Complete"
    ];

    const SKIN_STEPS = [
        "Start Predicting Skin Tone",
        "Removing Motion Artifacts",
        "Intensity Calibration",
        "Incident Light Measurement",
        "Ambient Light Cancellation",
        "Reflectance Feature Extraction",
        "Data Normalization",
        "Passing into Machine Learning Model",
        "Complete"
    ];

    function renderSteps(kind) {
        const steps = (kind === "lactate") ? LACTATE_STEPS : SKIN_STEPS;
        const ul = document.getElementById(kind === "lactate" ? "lactate-steps" : "skin-steps");
        ul.innerHTML = "";
        steps.forEach(s => {
            const li = document.createElement("li");
            li.innerText = s;
            ul.appendChild(li);
        });
    }

    function setActiveStep(kind, idx) {
        const ul = document.getElementById(kind === "lactate" ? "lactate-steps" : "skin-steps");
        const items = [...ul.querySelectorAll("li")];
        items.forEach((li, i) => {
            li.classList.remove("active");
            li.classList.remove("done");
            if (i < idx) li.classList.add("done");
            if (i === idx) li.classList.add("active");
        });
    }

    function showSpinner(kind, show) {
        const spinner = document.getElementById(kind === "lactate" ? "lactate-spinner" : "skin-spinner");
        spinner.style.display = show ? "flex" : "none";
    }

    function setProgress(kind, pct) {
        const bar = document.getElementById(kind === "lactate" ? "lactate-progress" : "skin-progress");
        const txt = document.getElementById(kind === "lactate" ? "lactate-progress-text" : "skin-progress-text");
        bar.style.width = pct + "%";
        txt.innerText = pct + "%";
    }

    function setCaptureText(kind, elapsed, total) {
        const el = document.getElementById(kind === "lactate" ? "lactate-capture-text" : "skin-capture-text");
        el.innerText = `Recording data: ${elapsed}s / ${total}s`;
    }

    function resetResult(kind) {
        const box = document.getElementById(kind === "lactate" ? "lactate-result" : "skin-result");
        box.style.display = "none";
        if (kind === "lactate") {
            document.getElementById("lactate-value").innerText = "—";
            document.getElementById("lactate-note").innerText = "";
            document.getElementById("lactate-file").innerText = "";
        } else {
            document.getElementById("skin-value").innerText = "—";
            document.getElementById("skin-note").innerText = "";
            document.getElementById("skin-file").innerText = "";
        }
    }

    function showResult(kind, payload) {
        const box = document.getElementById(kind === "lactate" ? "lactate-result" : "skin-result");
        box.style.display = "block";

        if (kind === "lactate") {
            const p = payload.prediction || {};
            const val = (p.value === null || p.value === undefined) ? "—" : `${p.value} ${p.units || ""}`.trim();
            document.getElementById("lactate-value").innerText = val;
            document.getElementById("lactate-note").innerText = p.note ? `Note: ${p.note}` : "";
            document.getElementById("lactate-file").innerText = payload.file_path ? `Captured file: ${payload.file_path}` : "";
        } else {
            const p = payload.prediction || {};
            const val = (p.value === null || p.value === undefined) ? "—" : `${p.value} (${p.scale || "scale"})`;
            document.getElementById("skin-value").innerText = val;
            document.getElementById("skin-note").innerText = p.note ? `Note: ${p.note}` : "";
            document.getElementById("skin-file").innerText = payload.file_path ? `Captured file: ${payload.file_path}` : "";
        }
    }

    function setButtonsEnabled(enabled) {
        document.getElementById("btn-lactate").disabled = !enabled;
        document.getElementById("btn-skin").disabled = !enabled;
    }

    async function startLactatePrediction() {
        setButtonsEnabled(false);
        renderSteps("lactate");
        setActiveStep("lactate", 0);
        resetResult("lactate");
        showSpinner("lactate", true);
        setProgress("lactate", 0);
        setCaptureText("lactate", 0, 60);

        const res = await fetch('/predict_lactate', { method: 'POST' });
        const data = await res.json();
        if (data.status !== "started") {
            alert("Failed to start lactate prediction.");
            setButtonsEnabled(true);
            showSpinner("lactate", false);
        }
    }

    async function startSkinTonePrediction() {
        setButtonsEnabled(false);
        renderSteps("skin");
        setActiveStep("skin", 0);
        resetResult("skin");
        showSpinner("skin", true);
        setProgress("skin", 0);
        setCaptureText("skin", 0, 60);

        const res = await fetch('/predict_skin_tone', { method: 'POST' });
        const data = await res.json();
        if (data.status !== "started") {
            alert("Failed to start skin tone prediction.");
            setButtonsEnabled(true);
            showSpinner("skin", false);
        }
    }

    // Live capture timer ticks (from server)
    socket.on('prediction_capture_tick', (msg) => {
        if (!msg || !msg.kind) return;
        setCaptureText(msg.kind, msg.seconds_elapsed, msg.seconds_total);

        // Keep bar moving during capture (0..35%)
        const pct = Math.min(35, Math.floor((msg.seconds_elapsed / msg.seconds_total) * 35));
        setProgress(msg.kind, pct);
    });

    // Workflow steps (from server)
    socket.on('prediction_progress', (msg) => {
        if (!msg || !msg.kind) return;

        setActiveStep(msg.kind, msg.step_index);

        // After capture finishes, server-driven percent will take over (35..100)
        const pct = Math.max(35, msg.percent);
        setProgress(msg.kind, pct);
    });

    // Final result (from server)
    socket.on('prediction_result', (msg) => {
        if (!msg || !msg.kind) return;

        showSpinner(msg.kind, false);

        if (!msg.ok) {
            alert((msg.kind === "lactate" ? "Lactate" : "Skin Tone") + " prediction failed: " + (msg.error || "Unknown error"));
            setButtonsEnabled(true);
            return;
        }

        setProgress(msg.kind, 100);
        showResult(msg.kind, msg);
        setButtonsEnabled(true);
    });

    window.onload = loadPorts;
</script>
</body>
</html>
